# 功能規格：登入記帳主頁功能（後端）

**功能分支**: `001-login-homepage`  
**建立日期**: 2025-11-18  
**狀態**: Draft  
**輸入**: 使用者描述："登入記帳主頁功能 backend"  
**參考文件**: [使用者原始需求](https://github.com/chunchun1213/money-manager-doc/blob/feature/login-homepage/spec/1-%E4%BD%BF%E7%94%A8%E8%80%85%E5%8E%9F%E5%A7%8B%E9%9C%80%E6%B1%82.md)  
**Figma 設計**: [登入記帳主頁功能](https://www.figma.com/design/oWY8jjLOAJyY2z7FJ8gUrh/%E7%99%BB%E5%85%A5%E8%A8%98%E5%B8%B3%E4%B8%BB%E9%A0%81%E5%8A%9F%E8%83%BD?node-id=0-1&p=f&t=9PckrohafPMw8gZN-0)

## 使用者場景與測試 *(必填)*

### 使用者故事 1 - 社群帳號登入 (優先級：P1)

使用者可以使用 Google 或 Facebook 帳號登入記帳應用程式。登入成功後，系統會建立使用者會話（session），並在後續訪問時自動驗證使用者身份。

**為何此優先級**：登入是應用程式的核心入口功能。沒有登入功能，使用者無法存取任何個人化的記帳資料。這是 MVP 的基礎功能。

**獨立測試**：可以透過發送社群登入請求（Google/Facebook OAuth token）到後端 API，驗證是否成功建立使用者帳號和會話，並返回有效的認證 token。

**驗收場景**：

1. **Given** 使用者尚未註冊，**When** 使用者透過 Google 帳號首次登入，**Then** 系統應建立新使用者帳號，產生會話 token，並返回使用者基本資訊
2. **Given** 使用者已經註冊過，**When** 使用者透過 Google 帳號再次登入，**Then** 系統應驗證使用者身份，產生新的會話 token，並返回使用者資訊
3. **Given** 使用者透過 Facebook 帳號登入，**When** 該 Facebook 帳號的 email 與現有 Google 帳號相同，**Then** 系統應將兩個社群帳號連結到同一使用者
4. **Given** 使用者提供無效的 OAuth token，**When** 使用者嘗試登入，**Then** 系統應返回明確的錯誤訊息並拒絕登入
5. **Given** 使用者已登入，**When** 使用者發送包含有效 token 的請求，**Then** 系統應自動驗證使用者身份而不需重新登入

---

### 使用者故事 2 - 登出功能 (優先級：P2)

使用者可以登出系統，清除當前的會話資料，確保帳號安全。

**為何此優先級**：登出是重要的安全功能，但不是初期 MVP 的阻塞功能。使用者可以先使用登入功能，登出功能可以稍後添加。

**獨立測試**：可以透過發送登出請求到後端 API，驗證會話是否被正確撤銷，後續使用該 token 的請求應被拒絕。

**驗收場景**：

1. **Given** 使用者已登入，**When** 使用者執行登出操作，**Then** 系統應撤銷當前會話 token
2. **Given** 使用者已登出，**When** 使用者使用已撤銷的 token 訪問受保護的 API，**Then** 系統應返回 401 未授權錯誤
3. **Given** 使用者在多個裝置登入，**When** 使用者在其中一個裝置登出，**Then** 系統應只撤銷該裝置的會話，其他裝置仍可正常使用
4. **Given** 使用者提供無效或過期的 token，**When** 使用者嘗試登出，**Then** 系統應返回適當的錯誤訊息

---

### 使用者故事 3 - 記帳主頁資料 API (優先級：P3)

使用者登入後可以訪問記帳主頁，後端提供主頁所需的基本資料結構（目前為佔位資料）。

**為何此優先級**：根據原始需求，記帳主頁目前只需要「簡單的施工中圖示」。這是為了驗證前後端整合，但不需要實際的記帳業務邏輯。

**獨立測試**：可以透過發送帶有有效認證 token 的請求到主頁 API，驗證是否返回預期的佔位資料結構。

**驗收場景**：

1. **Given** 使用者已登入，**When** 使用者請求主頁資料，**Then** 系統應返回包含使用者基本資訊和佔位內容的回應
2. **Given** 使用者未登入，**When** 使用者嘗試訪問主頁 API，**Then** 系統應返回 401 未授權錯誤
3. **Given** 使用者的 token 已過期，**When** 使用者請求主頁資料，**Then** 系統應返回 401 錯誤並提示需要重新登入

---

### 邊界案例

- **網路異常**：當社群登入服務（Google/Facebook）無回應或超時時，系統應如何處理？
- **重複登入**：當使用者在短時間內多次發起登入請求時，系統如何避免建立重複的使用者帳號？
- **Email 衝突**：當不同社群帳號（Google 和 Facebook）使用相同 email 時，系統如何處理帳號連結？
- **Token 過期**：當使用者的會話 token 過期時，前端應收到什麼樣的錯誤回應？
- **並發會話**：使用者在多個裝置同時登入時，系統如何管理多個活躍會話？
- **部分資料**：當社群登入回傳的使用者資料不完整（例如沒有 email）時，系統應如何處理？

## 功能需求 *(必填)*

### 功能需求

- **FR-001**: 系統必須支援 Google OAuth 2.0 登入流程，接受 Google ID token 並驗證其有效性
- **FR-002**: 系統必須支援 Facebook Login 登入流程，接受 Facebook access token 並驗證其有效性
- **FR-003**: 系統必須在首次登入時自動建立新使用者帳號，儲存社群帳號提供的基本資訊（email、姓名、頭像）
- **FR-004**: 系統必須為登入成功的使用者產生會話 token（JWT 或類似機制）
- **FR-005**: 系統必須能夠驗證使用者提供的會話 token，並識別使用者身份
- **FR-006**: 系統必須提供登出 API，撤銷指定的會話 token
- **FR-007**: 系統必須記錄使用者的最後登入時間
- **FR-008**: 系統必須能夠將相同 email 的不同社群帳號連結到同一使用者
- **FR-009**: 系統必須提供受保護的主頁 API，只允許已驗證的使用者訪問
- **FR-010**: 系統必須為所有認證相關操作記錄審計日誌（登入、登出、token 驗證失敗）
- **FR-011**: 系統必須處理並返回清晰的錯誤訊息給前端，包括：無效 token、過期 token、社群登入失敗等情況
- **FR-012**: 系統必須設定會話 token 的過期時間（預設建議：30 天）
- **FR-013**: 系統必須支援 token 更新機制（refresh token），避免使用者頻繁重新登入

### 關鍵實體

- **使用者 (User)**: 代表應用程式的使用者帳號。屬性包括：唯一識別碼、email、姓名、頭像 URL、建立時間、最後登入時間。
- **社群帳號連結 (SocialAccount)**: 代表使用者連結的社群登入帳號。屬性包括：提供者類型（Google/Facebook）、提供者使用者 ID、連結時間。一個使用者可以連結多個社群帳號。
- **會話 (Session)**: 代表使用者的登入會話。屬性包括：會話 token、使用者識別碼、建立時間、過期時間、裝置資訊（選填）、是否已撤銷。
- **審計日誌 (AuditLog)**: 記錄所有安全相關操作。屬性包括：操作類型（登入/登出/驗證失敗）、使用者識別碼、時間戳記、IP 位址、結果（成功/失敗）、錯誤訊息（如有）。

## 成功標準 *(必填)*

### 可衡量的成果

- **SC-001**: 使用者可以在 3 秒內完成社群帳號登入流程（從發起請求到收到 token）
- **SC-002**: 系統可以同時處理至少 100 個並發登入請求而不出現錯誤或明顯延遲
- **SC-003**: 所有 API 端點的 p95 回應時間必須小於 200ms（讀取操作）或 500ms（寫入操作）
- **SC-004**: 登入成功率達到 99%（排除因使用者提供無效 token 導致的失敗）
- **SC-005**: 所有認證相關的錯誤都必須返回明確的錯誤碼和使用者友善的錯誤訊息
- **SC-006**: 會話 token 必須通過標準的安全性驗證（防止 token 偽造、重放攻擊）
- **SC-007**: 系統必須記錄 100% 的認證操作到審計日誌，確保可追蹤性
