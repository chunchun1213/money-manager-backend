# 澄清會議報告：登入記帳主頁功能（後端）

**功能分支**: `001-login-homepage`  
**會議日期**: 2025-11-18  
**參與者**: 專案團隊  
**規格版本**: Draft  
**會議目的**: 識別並解決規格中的模糊性與缺失決策點

---

## 執行摘要

本次澄清會議針對「登入記帳主頁功能」後端規格進行了系統性的模糊性掃描，識別出 5 個高優先級的架構與設計決策點。所有問題均已獲得明確答案並整合至規格文件中。

**關鍵成果**：
- ✅ 提出並解決 5 個關鍵問題
- ✅ 新增 3 個功能需求（FR-014 至 FR-016）
- ✅ 更新 3 個現有功能需求（FR-001, FR-002, FR-008）
- ✅ 更新 3 個實體定義（User, Session, AuditLog）
- ✅ 新增 1 個邊界案例（帳號刪除）
- ✅ 所有關鍵架構決策已明確化

---

## 問題與決策記錄

### 問題 1：OAuth 2.0 流程類型

**類別**: 整合與外部相依性  
**優先級**: 高（影響前後端整合架構）  
**問題描述**: 規格提到支援 Google OAuth 2.0 和 Facebook Login，但沒有明確說明使用哪種 OAuth 流程。不同的流程類型會影響前後端整合架構、安全性和使用者體驗。

**提供的選項**:
- **選項 A**: Implicit Flow - 前端直接取得 access token，後端驗證 token（較簡單但安全性較低）
- **選項 B**: Authorization Code Flow (with PKCE) - 前端取得授權碼，後端交換 token（最安全，業界最佳實踐）✅
- **選項 C**: Server-side Flow - 完全在後端處理 OAuth（最安全但需後端渲染頁面）

**決策**: **選項 B - Authorization Code Flow (with PKCE)**

**決策理由**:
- 這是目前業界針對行動應用程式和單頁應用程式（SPA）的最佳實踐
- 提供最高的安全性，防止授權碼攔截攻擊
- 同時支援前後端分離架構
- 符合現代應用程式架構和安全標準

**影響範圍**:
- FR-001: 更新為明確說明使用 Authorization Code Flow with PKCE，接受前端提供的授權碼
- FR-002: 同樣更新 Facebook Login 流程說明

---

### 問題 2：會話 Token 儲存策略

**類別**: 延展性與資料模型  
**優先級**: 高（影響水平擴展能力）  
**問題描述**: 規格提到系統需要產生和驗證會話 token，但沒有說明 token 的儲存位置。這會影響系統的水平擴展能力、效能和部署架構。

**提供的選項**:
- **選項 A**: 無狀態 JWT - Token 自包含所有資訊，後端不儲存（最快但無法即時撤銷）
- **選項 B**: 資料庫儲存（可擴展）- 會話資料存在資料庫，支援即時撤銷和審計（推薦用於多裝置）✅
- **選項 C**: Redis 快取 - 會話存在 Redis，高效能但需額外基礎設施

**決策**: **選項 B - 資料庫儲存（可擴展）**

**決策理由**:
- 支援即時撤銷 token（登出功能需求）
- 可追蹤多裝置會話
- 支援詳細的審計日誌記錄
- 對於目標 100 並發使用者規模完全足夠
- 實作和維護成本較低
- 可透過資料庫複製實現水平擴展

**影響範圍**:
- Session 實體: 更新說明為「儲存在資料庫中以支援即時撤銷和多裝置管理」

---

### 問題 3：Email 唯一性規則

**類別**: 資料模型  
**優先級**: 中高（影響帳號連結邏輯）  
**問題描述**: 規格提到系統需要處理「相同 email 的不同社群帳號」並將其連結到同一使用者，但沒有明確定義 email 的唯一性規則。這會影響帳號建立邏輯和資料模型設計。

**提供的選項**:
- **選項 A**: Email 全域唯一 - 一個 email 只能對應一個使用者，多個社群帳號可連結同一使用者（推薦）✅
- **選項 B**: 每個社群帳號獨立 - 同 email 的 Google 和 Facebook 帳號視為不同使用者
- **選項 C**: 使用者可選擇 - 登入時詢問使用者是否要連結或建立新帳號

**決策**: **選項 A - Email 全域唯一**

**決策理由**:
- 對於金融記帳應用程式，每個 email 應該只對應一個使用者帳號
- 避免混淆和安全問題
- 當使用者用不同社群帳號但相同 email 登入時，系統自動連結到現有使用者
- 確保使用者的所有記帳資料集中在一個帳號下
- 符合驗收場景 3 的描述

**影響範圍**:
- FR-008: 新增說明「每個 email 在系統中必須是全域唯一的，當使用者用新的社群帳號（但相同 email）登入時，自動連結到現有使用者而非建立新帳號」
- User 實體: email 屬性標註為「全域唯一」

---

### 問題 4：個資保護與合規要求

**類別**: 安全性與合規  
**優先級**: 高（影響資料處理方式）  
**問題描述**: 規格涉及處理使用者的個人資訊（email、姓名、頭像）和審計日誌（IP 位址），但沒有提及資料保護和隱私合規要求。這會影響資料處理方式、保留策略和使用者權限設計。

**提供的選項**:
- **選項 A**: 無特殊要求 - 僅遵循一般安全最佳實踐，無額外合規要求
- **選項 B**: 基本資料保護 - 支援帳號刪除、資料加密、明確告知收集用途（推薦 MVP）✅
- **選項 C**: 完整 GDPR 合規 - 包含資料匯出、同意管理、資料處理協議、DPO 等完整合規機制

**決策**: **選項 B - 基本資料保護**

**決策理由**:
- 為 MVP 階段提供合理的隱私保護基礎
- 包括使用者可以刪除帳號及相關資料
- 敏感資料加密儲存（密碼雜湊已在憲章中要求）
- 明確告知使用者資料收集用途
- 符合大多數地區的基本隱私要求
- 不會過度增加開發複雜度
- 可在後續版本中逐步加強

**影響範圍**:
- **新增 FR-014**: 系統必須提供帳號刪除功能，當使用者刪除帳號時，永久移除所有個人資料（使用者資訊、社群帳號連結、會話記錄），但保留匿名化的審計日誌以符合安全追蹤需求
- **新增 FR-015**: 系統必須在首次登入時明確告知使用者資料收集的用途（提供登入服務、個人化體驗），並確保敏感資料（如 IP 位址）經過適當加密儲存
- **新增邊界案例**: 帳號刪除 - 當使用者刪除帳號後，如何處理審計日誌中的個人識別資訊？如何確保資料不可恢復？

---

### 問題 5：審計日誌保留策略

**類別**: 可觀測性  
**優先級**: 中（影響儲存設計）  
**問題描述**: 規格要求系統記錄 100% 的認證操作到審計日誌，但沒有說明日誌的保留期限。這會影響資料庫儲存容量規劃和資料清理策略。

**提供的選項**:
- **選項 A**: 30 天保留 - 短期保留，適合快速除錯和即時安全監控
- **選項 B**: 90 天保留 - 中期保留，平衡安全追蹤需求與儲存成本（推薦 MVP）✅
- **選項 C**: 永久保留 - 所有日誌永久保存，適合高度合規要求
- **選項 D**: 1 年保留 - 長期保留，適合詳細的安全分析和合規審計

**決策**: **選項 B - 90 天保留**

**決策理由**:
- 為 MVP 階段提供合理的安全追蹤能力
- 足以應對大多數安全事件調查（通常在事件發生後數週內發現）
- 不會造成過大的儲存負擔
- 符合許多業界標準的短期審計要求
- 在安全需求與成本之間取得良好平衡

**影響範圍**:
- **新增 FR-016**: 系統必須實施審計日誌自動清理機制，將超過 90 天的日誌記錄自動永久刪除，以控制儲存成本並符合資料保留政策
- AuditLog 實體: 更新說明為「保留 90 天後自動清理」，IP 位址標註為「加密」

---

## 規格變更摘要

### 新增內容

#### 新章節
- **澄清事項**: 記錄 5 個關鍵決策點及其答案

#### 新增功能需求（3 個）
- **FR-014**: 帳號刪除功能與資料清理規則
- **FR-015**: 資料收集告知與敏感資料加密
- **FR-016**: 審計日誌自動清理機制（90 天）

#### 更新的功能需求（3 個）
- **FR-001**: 明確指定 Google OAuth 使用 Authorization Code Flow with PKCE
- **FR-002**: 明確指定 Facebook Login 使用 Authorization Code Flow with PKCE
- **FR-008**: 新增 email 全域唯一性說明和自動連結邏輯

#### 更新的實體定義（3 個）
- **User**: email 標註為「全域唯一」
- **Session**: 新增「儲存在資料庫中以支援即時撤銷和多裝置管理」說明
- **AuditLog**: 新增「保留 90 天後自動清理」和「IP 位址（加密）」說明

#### 新增邊界案例（1 個）
- **帳號刪除**: 資料清理與審計日誌匿名化處理

### 規格完整性改善

| 指標 | 澄清前 | 澄清後 | 改善 |
|------|--------|--------|------|
| 功能需求數量 | 13 | 16 | +3 (23%) |
| 明確的架構決策 | 部分 | 完整 | 5 個關鍵決策 |
| 實體定義完整度 | 良好 | 優秀 | 3 個實體強化 |
| 邊界案例覆蓋 | 6 | 7 | +1 |
| 模糊性標記 | 無 | 無 | 維持 |

---

## 分類學覆蓋率分析

### 最終狀態總覽

| 類別 | 初始狀態 | 最終狀態 | 說明 |
|------|----------|----------|------|
| 功能範圍與行為 | ✅ Clear | ✅ Clear | 核心目標、範圍、使用者角色已明確 |
| 領域與資料模型 | ⚠️ Partial | ✅ Resolved | Email 唯一性、會話儲存策略已明確 |
| 互動與 UX 流程 | ✅ Clear | ✅ Clear | 使用者旅程、錯誤狀態已定義 |
| 非功能品質屬性 | ⚠️ Partial | ✅ Resolved | 延展性、可觀測性、安全性、合規已明確 |
| 整合與外部相依性 | ⚠️ Partial | ✅ Resolved | OAuth 流程類型已明確 |
| 邊界案例與失敗處理 | ✅ Clear | ✅ Resolved | 新增帳號刪除案例 |
| 約束與權衡 | ❌ Missing | ⚠️ Deferred | 技術約束延後至規劃階段 |
| 術語與一致性 | ✅ Clear | ✅ Clear | 術語使用一致 |
| 完成信號 | ✅ Clear | ✅ Clear | 驗收標準可測試 |
| 其他/佔位符 | ✅ Clear | ✅ Clear | 無 TODO 或模糊形容詞 |

### 解決的關鍵模糊性

1. ✅ **OAuth 流程選擇** - 從 3 種可能縮減到明確的 PKCE 流程
2. ✅ **Token 儲存位置** - 從未定義到資料庫儲存策略
3. ✅ **Email 唯一性** - 從隱含到明確的全域唯一規則
4. ✅ **合規要求** - 從缺失到基本資料保護措施
5. ✅ **日誌保留** - 從未定義到明確的 90 天策略

---

## 延後至規劃階段的項目

以下項目被識別但判定更適合在 `/speckit.plan` 階段處理：

1. **技術約束**（程式語言、框架、資料庫技術）
   - 理由：這些是實作細節，屬於技術選型範疇
   
2. **外部服務失敗的詳細重試策略**
   - 理由：需要在技術設計階段根據實際網路環境細化
   
3. **速率限制具體數值**
   - 理由：可在效能測試後根據實際表現調整
   
4. **部署環境與基礎設施**
   - 理由：屬於運維與部署規劃範疇

---

## 風險評估

### 已降低的風險

| 風險 | 澄清前風險等級 | 澄清後風險等級 | 緩解措施 |
|------|----------------|----------------|----------|
| OAuth 整合實作錯誤 | 高 | 低 | 明確指定 PKCE 流程 |
| 水平擴展困難 | 中 | 低 | 確定資料庫儲存策略 |
| 帳號重複建立 | 中 | 低 | Email 全域唯一規則 |
| 合規風險 | 中 | 低 | 基本資料保護措施 |
| 儲存成本失控 | 低 | 低 | 90 天日誌清理策略 |

### 殘留風險

| 風險 | 風險等級 | 建議緩解措施 |
|------|----------|--------------|
| 技術棧選擇不當 | 低 | 在規劃階段進行技術評估 |
| 外部服務不穩定 | 低 | 實作重試與降級機制 |

---

## 下一步行動建議

### 立即行動
1. ✅ **規格已就緒** - 可以進入 `/speckit.plan` 階段
2. ✅ **所有關鍵決策已記錄** - 團隊可以開始技術設計

### 規劃階段重點
1. 根據已明確的 OAuth 流程設計前後端整合介面
2. 設計資料庫 Schema（使用者、會話、社群帳號連結、審計日誌表）
3. 定義 API 端點規格（登入、登出、主頁、帳號刪除）
4. 規劃審計日誌清理的定時任務
5. 評估並選擇技術棧（程式語言、框架、ORM）

### 實作階段優先級
- **P1（必須）**: 社群帳號登入（包含 OAuth PKCE 流程、會話管理、email 唯一性檢查）
- **P2（重要）**: 登出功能（會話撤銷）
- **P3（可選）**: 記帳主頁 API（佔位資料）
- **後續版本**: 帳號刪除、審計日誌清理定時任務

---

## 結論

本次澄清會議成功解決了規格中的 5 個關鍵架構決策點，將規格的完整性從「良好」提升至「優秀」等級。所有高優先級的模糊性已被消除，規格現在具備清晰的：

✅ OAuth 整合策略（Authorization Code Flow with PKCE）  
✅ 資料模型規則（Email 全域唯一、會話資料庫儲存）  
✅ 合規要求（基本資料保護、90 天日誌保留）  
✅ 安全性考量（資料加密、審計追蹤、帳號刪除）  

**規格品質評估**: 🟢 **優秀** - 可以進入規劃階段

**建議的下一個指令**: `/speckit.plan`

---

**報告產生日期**: 2025-11-18  
**規格版本**: Draft (已澄清)  
**報告製作**: AI 系統分析
