openapi: 3.1.0
info:
  title: Money Manager Backend - ç™»å…¥è¨˜å¸³ä¸»é åŠŸèƒ½ API
  description: |
    å¾Œç«¯ API è¦æ ¼,æ”¯æ´ç¤¾ç¾¤å¸³è™Ÿç™»å…¥ (Google/Facebook OAuth 2.0)ã€æœƒè©±ç®¡ç†ã€ç™»å‡ºåŠŸèƒ½èˆ‡è¨˜å¸³ä¸»é åŸºæœ¬è³‡æ–™ã€‚
    
    **èªè­‰æ–¹å¼**: Bearer Token (JWT)
    **OAuth æµç¨‹**: Authorization Code Flow with PKCE
    **æ¸¬è©¦ç’°å¢ƒ**: https://api-dev.money-manager.example.com
    **æ­£å¼ç’°å¢ƒ**: https://api.money-manager.example.com
  version: 1.0.0
  contact:
    name: Money Manager Backend Team
    email: backend@money-manager.example.com
  license:
    name: Proprietary

servers:
  - url: https://api-dev.money-manager.example.com/api/v1
    description: é–‹ç™¼ç’°å¢ƒ
  - url: https://api.money-manager.example.com/api/v1
    description: æ­£å¼ç’°å¢ƒ

tags:
  - name: Authentication
    description: èªè­‰ç›¸é—œæ“ä½œ (ç™»å…¥ã€ç™»å‡ºã€Token é©—è­‰)
  - name: User
    description: ä½¿ç”¨è€…å¸³è™Ÿç®¡ç† (å¸³è™Ÿåˆªé™¤)
  - name: Homepage
    description: è¨˜å¸³ä¸»é è³‡æ–™ API

security:
  - BearerAuth: []

paths:
  /auth/login/google:
    post:
      tags:
        - Authentication
      summary: Google OAuth ç™»å…¥
      description: |
        æ¥å—å‰ç«¯æä¾›çš„ Google OAuth authorization code èˆ‡ code_verifier,
        å‘ Google äº¤æ› access token,å»ºç«‹æˆ–æ›´æ–°ä½¿ç”¨è€…å¸³è™Ÿ,ç”¢ç”Ÿ JWT session tokenã€‚
        
        **æµç¨‹**: 
        1. å‰ç«¯ä½¿ç”¨ Google OAuth SDK å–å¾— authorization code
        2. å‰ç«¯å°‡ code èˆ‡ code_verifier ç™¼é€çµ¦å¾Œç«¯
        3. å¾Œç«¯ä½¿ç”¨ Supabase Auth äº¤æ› token
        4. å¾Œç«¯å»ºç«‹/æ›´æ–° User èˆ‡ SocialAccount
        5. å¾Œç«¯ç”¢ç”Ÿ JWT token ä¸¦å»ºç«‹ Session è¨˜éŒ„
        6. å¾Œç«¯è¨˜éŒ„ AuditLog
      operationId: loginWithGoogle
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
                - code_verifier
              properties:
                code:
                  type: string
                  description: Google OAuth authorization code
                  example: "4/0AfJohXk..."
                code_verifier:
                  type: string
                  description: PKCE code verifier (43-128 å­—å…ƒ)
                  minLength: 43
                  maxLength: 128
                  example: "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk"
                device_info:
                  type: object
                  description: è£ç½®è³‡è¨Š (é¸å¡«)
                  properties:
                    user_agent:
                      type: string
                      example: "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X)"
                    platform:
                      type: string
                      example: "iOS 17.0"
      responses:
        '200':
          description: ç™»å…¥æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: OAuth token ç„¡æ•ˆæˆ–éæœŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "INVALID_OAUTH_TOKEN"
                message: "Google OAuth token ç„¡æ•ˆ,è«‹é‡æ–°ç™»å…¥"
                timestamp: "2025-01-18T10:30:00Z"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/login/facebook:
    post:
      tags:
        - Authentication
      summary: Facebook OAuth ç™»å…¥
      description: |
        æ¥å—å‰ç«¯æä¾›çš„ Facebook OAuth authorization code èˆ‡ code_verifier,
        å‘ Facebook äº¤æ› access token,å»ºç«‹æˆ–æ›´æ–°ä½¿ç”¨è€…å¸³è™Ÿ,ç”¢ç”Ÿ JWT session tokenã€‚
        
        **æµç¨‹**: èˆ‡ Google ç™»å…¥ç›¸åŒ,åƒ…æä¾›è€…ä¸åŒ
      operationId: loginWithFacebook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
                - code_verifier
              properties:
                code:
                  type: string
                  description: Facebook OAuth authorization code
                  example: "AQD8F..."
                code_verifier:
                  type: string
                  description: PKCE code verifier (43-128 å­—å…ƒ)
                  minLength: 43
                  maxLength: 128
                  example: "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk"
                device_info:
                  type: object
                  description: è£ç½®è³‡è¨Š (é¸å¡«)
                  properties:
                    user_agent:
                      type: string
                      example: "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X)"
                    platform:
                      type: string
                      example: "iOS 17.0"
      responses:
        '200':
          description: ç™»å…¥æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          description: OAuth token ç„¡æ•ˆæˆ–éæœŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "INVALID_OAUTH_TOKEN"
                message: "Facebook OAuth token ç„¡æ•ˆ,è«‹é‡æ–°ç™»å…¥"
                timestamp: "2025-01-18T10:30:00Z"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: ç™»å‡º
      description: |
        æ’¤éŠ·ç•¶å‰æœƒè©±çš„ JWT token,æ¸…é™¤æœƒè©±è¨˜éŒ„ã€‚
        ç™»å‡ºå¾Œ,è©² token å°‡ç„¡æ³•å†è¨ªå•å—ä¿è­·çš„ APIã€‚
        
        **æµç¨‹**:
        1. å‰ç«¯ç™¼é€ JWT token (Authorization header)
        2. å¾Œç«¯é©—è­‰ token ä¸¦æ‰¾åˆ°å°æ‡‰ Session
        3. å¾Œç«¯è¨­å®š Session.revoked = TRUE
        4. å¾Œç«¯æ¸…é™¤ Redis cache
        5. å¾Œç«¯è¨˜éŒ„ AuditLog
      operationId: logout
      security:
        - BearerAuth: []
      responses:
        '200':
          description: ç™»å‡ºæˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "ç™»å‡ºæˆåŠŸ"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /auth/verify:
    get:
      tags:
        - Authentication
      summary: é©—è­‰ Token
      description: |
        é©—è­‰ JWT token æ˜¯å¦æœ‰æ•ˆ,ä¸¦è¿”å›ä½¿ç”¨è€…åŸºæœ¬è³‡è¨Šã€‚
        ç”¨æ–¼å‰ç«¯æª¢æŸ¥ä½¿ç”¨è€…ç™»å…¥ç‹€æ…‹ã€‚
        
        **é©—è­‰æ¢ä»¶**:
        - Token æ ¼å¼æ­£ç¢º
        - Token ç°½åæœ‰æ•ˆ
        - Token æœªéæœŸ
        - Session æœªè¢«æ’¤éŠ· (revoked = FALSE)
      operationId: verifyToken
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Token æœ‰æ•ˆ
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/UserProfile'
                  session:
                    type: object
                    properties:
                      expires_at:
                        type: string
                        format: date-time
                        description: Session éæœŸæ™‚é–“
                        example: "2025-02-17T10:30:00Z"
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: æ›´æ–° Token
      description: |
        ä½¿ç”¨ refresh token å–å¾—æ–°çš„ JWT token,é¿å…ä½¿ç”¨è€…é »ç¹é‡æ–°ç™»å…¥ã€‚
        
        **æµç¨‹**:
        1. å‰ç«¯ç™¼é€ refresh token
        2. å¾Œç«¯é©—è­‰ refresh token æœ‰æ•ˆæ€§
        3. å¾Œç«¯ç”¢ç”Ÿæ–°çš„ JWT token èˆ‡ refresh token (rotation)
        4. å¾Œç«¯æ›´æ–° Session è¨˜éŒ„
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
                  description: Refresh token
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      responses:
        '200':
          description: Token æ›´æ–°æˆåŠŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Refresh token ç„¡æ•ˆæˆ–éæœŸ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "INVALID_REFRESH_TOKEN"
                message: "Refresh token ç„¡æ•ˆ,è«‹é‡æ–°ç™»å…¥"
                timestamp: "2025-01-18T10:30:00Z"
        '500':
          $ref: '#/components/responses/InternalServerError'

  /user/delete:
    delete:
      tags:
        - User
      summary: åˆªé™¤å¸³è™Ÿ
      description: |
        æ°¸ä¹…åˆªé™¤ä½¿ç”¨è€…å¸³è™ŸåŠæ‰€æœ‰é—œè¯è³‡æ–™ã€‚
        
        **åˆªé™¤ç¯„åœ**:
        - User è¨˜éŒ„ (auth.users)
        - æ‰€æœ‰ SocialAccount è¨˜éŒ„ (CASCADE)
        - æ‰€æœ‰ Session è¨˜éŒ„ (CASCADE)
        - AuditLog çš„ user_id è¨­ç‚º NULL (åŒ¿ååŒ–)
        
        **æ³¨æ„**: æ­¤æ“ä½œç„¡æ³•æ¢å¾©
      operationId: deleteAccount
      security:
        - BearerAuth: []
      responses:
        '200':
          description: å¸³è™Ÿåˆªé™¤æˆåŠŸ
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "å¸³è™Ÿå·²æ°¸ä¹…åˆªé™¤"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /homepage:
    get:
      tags:
        - Homepage
      summary: å–å¾—è¨˜å¸³ä¸»é è³‡æ–™
      description: |
        å–å¾—è¨˜å¸³ä¸»é æ‰€éœ€çš„åŸºæœ¬è³‡æ–™ (ç›®å‰ç‚ºä½”ä½è³‡æ–™)ã€‚
        
        **æ¬Šé™**: éœ€è¦æœ‰æ•ˆçš„ JWT token
        **å›æ‡‰**: ä½¿ç”¨è€…åŸºæœ¬è³‡è¨Š + ä½”ä½å…§å®¹
      operationId: getHomepage
      security:
        - BearerAuth: []
      responses:
        '200':
          description: ä¸»é è³‡æ–™
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/UserProfile'
                  content:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "æ–½å·¥ä¸­..."
                      icon:
                        type: string
                        example: "ğŸš§"
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token (å¾ /auth/login/* å–å¾—)

  schemas:
    LoginResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT access token (çŸ­æœŸæœ‰æ•ˆ, å»ºè­° 1 å°æ™‚)
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiMTIzZTQ1NjctZTg5Yi0xMmQzLWE0NTYtNDI2NjE0MTc0MDAwIiwic2Vzc2lvbl9pZCI6Ijk4N2Y2NTQzLWUyMWItMTJkMy1hNDU2LTQyNjYxNDE3NDAwMCIsImlhdCI6MTcwNTU2ODYwMCwiZXhwIjoxNzA1NTcyMjAwfQ.xyz123abc"
        refresh_token:
          type: string
          description: Refresh token (é•·æœŸæœ‰æ•ˆ, 30 å¤©)
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        token_type:
          type: string
          enum: [Bearer]
          example: "Bearer"
        expires_in:
          type: integer
          description: Access token æœ‰æ•ˆæœŸé™ (ç§’)
          example: 3600
        user:
          $ref: '#/components/schemas/UserProfile'
      required:
        - access_token
        - refresh_token
        - token_type
        - expires_in
        - user

    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: ä½¿ç”¨è€… ID
          example: "123e4567-e89b-12d3-a456-426614174000"
        email:
          type: string
          format: email
          description: ä½¿ç”¨è€… Email
          example: "user@example.com"
        name:
          type: string
          description: ä½¿ç”¨è€…å§“å
          example: "ç‹å°æ˜"
        avatar_url:
          type: string
          format: uri
          description: ä½¿ç”¨è€…é ­åƒ URL
          example: "https://lh3.googleusercontent.com/a/..."
        provider:
          type: string
          enum: [google, facebook]
          description: ä¸»è¦ OAuth æä¾›è€…
          example: "google"
        created_at:
          type: string
          format: date-time
          description: å¸³è™Ÿå»ºç«‹æ™‚é–“
          example: "2025-01-15T08:30:00Z"
        last_sign_in_at:
          type: string
          format: date-time
          description: æœ€å¾Œç™»å…¥æ™‚é–“
          example: "2025-01-18T10:30:00Z"
      required:
        - id
        - email
        - name
        - avatar_url
        - provider
        - created_at

    Error:
      type: object
      properties:
        error:
          type: string
          description: éŒ¯èª¤ç¢¼ (æ©Ÿå™¨å¯è®€)
          example: "INVALID_TOKEN"
        message:
          type: string
          description: éŒ¯èª¤è¨Šæ¯ (ä½¿ç”¨è€…å¯è®€, ç¹é«”ä¸­æ–‡)
          example: "Token ç„¡æ•ˆ,è«‹é‡æ–°ç™»å…¥"
        details:
          type: object
          description: é¡å¤–éŒ¯èª¤è©³æƒ… (é¸å¡«)
          additionalProperties: true
          example:
            field: "code"
            reason: "code åƒæ•¸æ ¼å¼ä¸æ­£ç¢º"
        timestamp:
          type: string
          format: date-time
          description: éŒ¯èª¤ç™¼ç”Ÿæ™‚é–“
          example: "2025-01-18T10:30:00Z"
      required:
        - error
        - message
        - timestamp

  responses:
    BadRequest:
      description: è«‹æ±‚åƒæ•¸éŒ¯èª¤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            missing_parameter:
              summary: ç¼ºå°‘å¿…å¡«åƒæ•¸
              value:
                error: "MISSING_PARAMETER"
                message: "ç¼ºå°‘å¿…å¡«åƒæ•¸: code"
                details:
                  field: "code"
                  reason: "code åƒæ•¸ç‚ºå¿…å¡«"
                timestamp: "2025-01-18T10:30:00Z"
            invalid_format:
              summary: åƒæ•¸æ ¼å¼éŒ¯èª¤
              value:
                error: "INVALID_FORMAT"
                message: "code_verifier é•·åº¦å¿…é ˆä»‹æ–¼ 43-128 å­—å…ƒ"
                details:
                  field: "code_verifier"
                  reason: "é•·åº¦ = 30, å¿…é ˆ >= 43"
                timestamp: "2025-01-18T10:30:00Z"

    Unauthorized:
      description: æœªæˆæ¬Š (Token ç„¡æ•ˆã€éæœŸæˆ–ç¼ºå°‘)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          examples:
            missing_token:
              summary: ç¼ºå°‘ Token
              value:
                error: "MISSING_TOKEN"
                message: "è«‹æä¾› Authorization header"
                timestamp: "2025-01-18T10:30:00Z"
            invalid_token:
              summary: Token ç„¡æ•ˆ
              value:
                error: "INVALID_TOKEN"
                message: "Token æ ¼å¼ä¸æ­£ç¢ºæˆ–ç°½åç„¡æ•ˆ"
                timestamp: "2025-01-18T10:30:00Z"
            expired_token:
              summary: Token éæœŸ
              value:
                error: "EXPIRED_TOKEN"
                message: "Token å·²éæœŸ,è«‹é‡æ–°ç™»å…¥"
                timestamp: "2025-01-18T10:30:00Z"
            revoked_token:
              summary: Token å·²æ’¤éŠ·
              value:
                error: "REVOKED_TOKEN"
                message: "æ­¤ Token å·²ç™»å‡º,è«‹é‡æ–°ç™»å…¥"
                timestamp: "2025-01-18T10:30:00Z"

    InternalServerError:
      description: ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "INTERNAL_SERVER_ERROR"
            message: "ç³»çµ±éŒ¯èª¤,è«‹ç¨å¾Œå†è©¦"
            timestamp: "2025-01-18T10:30:00Z"
